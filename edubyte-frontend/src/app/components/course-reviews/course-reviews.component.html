<div class="w-full">
  <!-- Review Statistics -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-2xl font-bold mb-4">Reseñas del Curso</h2>

    <div class="flex items-center gap-4 mb-6">
      <div class="text-center">
        <div class="text-5xl font-bold text-primary-600">{{ reviewStats.averageRating.toFixed(1) }}</div>
        <app-star-rating
          [rating]="reviewStats.averageRating"
          [readonly]="true"
          size="md">
        </app-star-rating>
        <p class="text-sm text-gray-600 mt-2">{{ reviewStats.reviewCount }} {{ reviewStats.reviewCount === 1 ? 'reseña' : 'reseñas' }}</p>
      </div>
    </div>

    <!-- Add Review Button (Only for enrolled students) -->
    @if (isStudent && isEnrolled && !hasReviewed && !showReviewForm) {
      <button
        (click)="toggleReviewForm()"
        class="w-full bg-primary-600 text-white py-3 px-4 rounded-lg hover:bg-primary-700 transition-colors font-medium">
        Escribir una reseña
      </button>
    }

    <!-- Edit/Delete User Review (If student has already reviewed) -->
    @if (isStudent && hasReviewed && userReview && !showReviewForm) {
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start justify-between mb-2">
          <div>
            <p class="font-semibold text-blue-900">Tu reseña</p>
            <app-star-rating
              [rating]="userReview.calificacion"
              [readonly]="true"
              size="sm">
            </app-star-rating>
          </div>
          <div class="flex gap-2">
            <button
              (click)="startEdit()"
              class="text-blue-600 hover:text-blue-800 text-sm font-medium">
              Editar
            </button>
            <button
              (click)="deleteReview()"
              class="text-red-600 hover:text-red-800 text-sm font-medium">
              Eliminar
            </button>
          </div>
        </div>
        @if (userReview.comentario) {
          <p class="text-gray-700 text-sm mt-2">{{ userReview.comentario }}</p>
        }
        <p class="text-xs text-gray-500 mt-2">Publicado el {{ userReview.creadoEn }}</p>
      </div>
    }

    <!-- Review Form -->
    @if (showReviewForm) {
      <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="mt-6 bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">{{ isEditMode ? 'Editar tu reseña' : 'Escribe tu reseña' }}</h3>

        <!-- Star Rating Input -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Calificación <span class="text-red-500">*</span>
          </label>
          <app-star-rating
            [rating]="reviewForm.get('calificacion')?.value || 0"
            [readonly]="false"
            size="lg"
            (ratingChange)="onRatingChange($event)">
          </app-star-rating>
          @if (reviewForm.get('calificacion')?.invalid && reviewForm.get('calificacion')?.touched) {
            <p class="text-red-500 text-sm mt-1">Por favor, selecciona una calificación</p>
          }
        </div>

        <!-- Comment Textarea -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Comentario (opcional)
          </label>
          <textarea
            formControlName="comentario"
            rows="4"
            maxlength="900"
            placeholder="Comparte tu experiencia con este curso..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none">
          </textarea>
          <p class="text-xs text-gray-500 mt-1">
            {{ reviewForm.get('comentario')?.value?.length || 0 }}/900 caracteres
          </p>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-3">
          <button
            type="submit"
            [disabled]="reviewForm.invalid"
            class="flex-1 bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium">
            {{ isEditMode ? 'Actualizar reseña' : 'Publicar reseña' }}
          </button>
          <button
            type="button"
            (click)="toggleReviewForm()"
            class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors font-medium">
            Cancelar
          </button>
        </div>
      </form>
    }
  </div>

  <!-- Reviews List -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-xl font-semibold mb-4">Todas las reseñas</h3>

    @if (isLoading) {
      <div class="flex justify-center items-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    } @else if (reviews.length === 0) {
      <div class="text-center py-8">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
        </svg>
        <p class="text-gray-500 mt-2">No hay reseñas todavía</p>
        <p class="text-sm text-gray-400">Sé el primero en compartir tu opinión</p>
      </div>
    } @else {
      <div class="space-y-4">
        @for (review of reviews; track review.id) {
          <div class="border-b border-gray-200 pb-4 last:border-b-0">
            <div class="flex items-start justify-between mb-2">
              <div>
                <p class="font-semibold text-gray-900">{{ review.usuarioNombre }} {{ review.usuarioApellido }}</p>
                <app-star-rating
                  [rating]="review.calificacion"
                  [readonly]="true"
                  size="sm">
                </app-star-rating>
              </div>
              <p class="text-xs text-gray-500">{{ review.creadoEn }}</p>
            </div>
            @if (review.comentario) {
              <p class="text-gray-700 text-sm">{{ review.comentario }}</p>
            }
          </div>
        }
      </div>
    }
  </div>
</div>
